#!/bin/bash
PROG=$(basename $0)
_msg(){
	echo "$1 $PROG@$(date -u +%Y%m%d%H%M%S): $2"
}

msg(){
	_msg '+++++' "$1"
}

err(){
	_msg '!!!!!' "$1"
}

silent='false'

while getopts 's' flag; do
  case "${flag}" in
    s) silent='true' ;;
    *) print_usage
       exit 1 ;;
  esac
done

LOCAL_CHANGES=`git diff`
if [[ $LOCAL_CHANGES ]]; then
    err "You have local changes. Please commit and push before deploying."
    exit 1
fi
git checkout master
MASTER_REV="$(git rev-parse --short HEAD)"
rm -f project/static/revision.txt   # ensure no debris from previous runs
git checkout deploy-production
git pull
git merge master -m "Merge branch 'master' into deploy-production" --no-ff
echo "PROD master rev=$MASTER_REV @ $(date -u +%Y%m%dU%H%M%S)" > project/static/revision.txt
git add project/static/revision.txt
git commit -a -m "deploy to AWS production"
git push --set-upstream origin
git checkout master

if ! $silent; then
	GOOGLE_CHAT_WEBHOOK_LINK="https://chat.googleapis.com/v1/spaces/AAAA4EpUJSg/messages?key=AIzaSyDdI0hCZtE6vySjMm-WEfRq3CPzqKqqsHI&token=bpvbOekeuFOZ8B9RseoHxXutNT_Ax1_3LQg1qe5-GLk"
	curl --silent --output /dev/null -X POST -H 'Content-Type: application/json' -d '{"text": "The LIVE server will have the latest changes in 15mins"}' $GOOGLE_CHAT_WEBHOOK_LINK
fi